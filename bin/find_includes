#!/bin/env python
# Finds and optionally deletes broken symbolic links
import sys, time, string, re, os, argparse, subprocess, shlex, fileinput

op = argparse.ArgumentParser(description="""
Description of script goes here
""")

op.add_argument('--includes',         help='Find includes with invalid filenames',action='store_true')
op.add_argument('--files',            help='Find files from given includes list')
op.add_argument('-X',                 help='Show commands, but do not execute',action='store_true')
op.add_argument('cmdline',            help='Positional arguments',nargs='*')
opts = op.parse_args(sys.argv[1:])

def run_cmd(cmd,quiet=None,read=None,always=False):
  if not quiet:
    print cmd
  if not opts.X or always:
    if not read:
      return os.system(cmd)
    else:
      proc = subprocess.Popen(shlex.split(cmd),stdout=subprocess.PIPE)
      return proc.stdout.readlines()
  return 0

# Rename `include filename in given file
def rename_include(file, include):
  if os.path.exists(file):
    #print 'rename: ', file, ' ', include
    for line in fileinput.input(file, inplace=True):
      line = line.rstrip()
      m = re.search(r'`include\s+.*%s\"' % include, line)
      if m:
        #print '>>> was:',file,' ',line
        new = re.sub(r'(`include\s+.*%s)"' % include, r'\1h"', line)
        #print '>>>> is: ', new
        print new
      else:
        print line
    fileinput.close()

if opts.includes:
  files = run_cmd("find . -type f -name '*.sv*'", read=True, quiet=True)
  for file in files:
    file = file.rstrip()
    for line in fileinput.input(file):
      if re.search(r'include', line):
        m = re.match(r'\s*`include\s+.*\.sv\"', line)
        if m:
          print file,' ', line,
    fileinput.close()

if opts.files:
  # Find files listed as includes from file generated by opts.includes
  # Done in separate steps so includes list can be manually modified
  # First get list of all files in current directory tree
  hash = {}
  renames = {}
  files = run_cmd("find . -name '*.sv'", read=True, quiet=True)
  for file in files:
    file = file.rstrip()
    base = os.path.basename(file)
    hash[base] = file
  for line in fileinput.input(opts.files):
    m = re.match(r'(\S+)\s+`include\s*\"(\S+)\"', line)
    if m:
      file = m.group(1)
      (head, include) = os.path.split(m.group(2))
      renames[include] = file
      #print '%s --> %s' % (file, include)
      if include in hash:
        print 'mv %s %sh' % (hash[include], hash[include])
        del hash[include]
  fileinput.close()
  for inc, file in renames.iteritems():
    rename_include(file, inc)
